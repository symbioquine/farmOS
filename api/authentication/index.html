<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Authentication - farmOS 2.x</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Authentication";
    var mkdocs_page_input_path = "api/authentication.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> farmOS 2.x</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">farmOS</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Hosting</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../hosting/migration/">1.x Migration</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../">Introduction</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Authentication</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#client-libraries">Client Libraries</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#oauth2-bearer-tokens">OAuth2 Bearer Tokens</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#oauth2-details">OAuth2 Details</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scopes">Scopes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#clients">Clients</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#authorization-flows">Authorization Flows</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#authorization-code-grant">Authorization Code Grant</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#password-credentials-grant">Password Credentials Grant</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#refreshing-tokens">Refreshing Tokens</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../changes/">Changes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Development</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Environment</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/">Getting started</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/docker/">Docker</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/postgresql/">PostgreSQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/drush/">Drush</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/composer/">Composer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/debug/">Debugging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/tests/">Automated tests</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/code/">Coding standards</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/environment/documentation/">Documentation</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Module</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../development/module/fields/">Fields</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/module/oauth/">OAuth</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../development/module/roles/">Roles</a>
                </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">farmOS 2.x</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>API &raquo;</li>
        
      
    
    <li>Authentication</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="authentication">Authentication</h1>
<p>farmOS includes an OAuth2 Authorization server for providing 1st and 3rd party
clients access to the farmOS API. Rather than using a user's username and
password to both <em>authorize and authenticate</em> a request, OAuth2 requires
users to complete an <em>authorization flow</em> that generates an <code>access_token</code>
to be used for authentication. Access tokens are provided to both 1st and
3rd party clients who wish to access the server's protected resources. Clients
store the <code>access token</code> instead of the user's credentials, which makes it a
more secure authentication method.</p>
<p>Read more about the <a href="https://oauth.net/2/">OAuth 2.0 standards</a>.</p>
<h2 id="client-libraries">Client Libraries</h2>
<p>The <a href="https://github.com/farmOS/farmOS.py">farmOS.py</a> and
<a href="https://github.com/farmOS/farmOS.js">farmOS.js</a> client libraries use the
OAuth2 protocol to interact with the farmOS API.</p>
<h2 id="oauth2-bearer-tokens">OAuth2 Bearer Tokens</h2>
<p>Once you have an OAuth2 token, you can authenticate requests to the farmOS
server by including an <code>Authentication: Bearer {access_token}</code> header.</p>
<h2 id="oauth2-details">OAuth2 Details</h2>
<p>The OAuth protocol defines a process where users <em>authorize</em> 1st and 3rd
party <em>clients</em> with <em>scoped</em> access to data on the server. The following
describes the details necessary for using OAuth2 authorization with a farmOS
server.</p>
<h3 id="scopes">Scopes</h3>
<p>OAuth Scopes define different levels of permission. The farmOS server
implements scopes as roles associated with OAuth clients. This means that users
will authorize clients with roles that determine how much access they have
to data on the server.</p>
<h3 id="clients">Clients</h3>
<p>An OAuth Client represents a 1st or 3rd party integration with the farmOS
server. Clients are uniquely identified by a <code>client_id</code> and are
configured to use different <code>scopes</code>.</p>
<p>The core <code>farm_api</code> module provides a default client with
<code>client_id = farm</code>. If you are writing a script that communicates with <em>your</em>
farmOS server via the API, you should use this client to authorize access and
generate an <code>access_token</code> for authentication.</p>
<p>If you are creating a third party integration with farmOS, see the
<a href="/development/module/oauth">OAuth</a> page of the farmOS module development docs
for steps to create an OAuth Client.</p>
<h3 id="authorization-flows">Authorization Flows</h3>
<p>The <a href="https://oauth.net/2/">OAuth 2.0 standards</a> outline 5
<a href="https://oauth.net/2/grant-types/">Oauth2 Grant Types</a> to be used in an OAuth2
Authorization Flow - They are the <em>Authorization Code, Implicit, Password
Credentials, Client Credentials</em> and <em>Refresh Token</em> Grants. The
<a href="#authorization-code-grant">Authorization Code</a> and
<a href="#refreshing-tokens">Refresh Token</a> grants are the only Authorization Flows
recommended by farmOS for use with 3rd party clients.</p>
<p><strong>NOTE:</strong> Only use the <strong>Password Grant</strong> if the client can be trusted with a
farmOS username and password (this is considered <em>1st party</em>). The
<strong>Client Credentials Grant</strong> is often used for machine authentication not
associated with a user account. The client credentials grant should only be
used if a <code>client_secret</code> can be kept secret. If connecting to multiple
farmOS servers, each server should use a different secret. This is
challenging due to the nature of farmOS being a self-hosted application.</p>
<h4 id="authorization-code-grant">Authorization Code Grant</h4>
<p>The Authorization Code Grant is most popular for 3rd party client
authorization.</p>
<p>Requesting resources is a four step process:</p>
<p><strong>First</strong>: the client sends a request to the farmOS server <code>/oauth/authorize</code>
endpoint requesting an <code>Authorization Code</code>. The user logs in and authorizes
the client to have the OAuth Scopes it is requesting.</p>
<pre><code>Copy this link to browser -
http://localhost/oauth/authorize?response_type=code&amp;client_id=farmos_development&amp;scope=user_access&amp;redirect_uri=http://localhost/api/authorized&amp;state=p4W8P5f7gJCIDbC1Mv78zHhlpJOidy
</code></pre>
<p><strong>Second</strong>: after the user accepts, the server redirects
to the <code>redirect_uri</code> with an authorization <code>code</code> and <code>state</code> in the query
parameters.</p>
<pre><code>Example redirect url from server:
http://localhost/api/authorized?code=9eb9442c7a2b011fd59617635cca5421cd089943&amp;state=p4W8P5f7gJCIDbC1Mv78zHhlpJOidy
</code></pre>
<p><strong>Third</strong>: copy the <code>code</code> and <code>state</code> from the URL into the body of a POST
request. The <code>grant_type</code>, <code>client_id</code>, <code>client_secret</code> and <code>redirect_uri</code> must
also be included in the POST body. The client makes a POST request to the
<code>/oauth/token</code> endpoint to retrieve an <code>access_token</code> and <code>refresh_token</code>.</p>
<pre><code>foo@bar:~$ curl -X POST -d "grant_type=authorization_code&amp;code=ae4d1381cc67def1c10dc88a19af6ac30d7b5959&amp;client_id=farmos_development&amp;redirect_uri=http://localhost/api/authorized" http://localhost/oauth/token
{"access_token":"3f9212c4a6656f1cd1304e47307927a7c224abb0","expires_in":"10","token_type":"Bearer","scope":"user_access","refresh_token":"292810b04d688bfb5c3cee28e45637ec8ef1dd9e"}
</code></pre>
<p><strong>Fourth</strong>: the client sends the access token in the request header to access protected
resources. The header is an Authorization header with a Bearer token:
 <code>Authorization: Bearer access_token</code></p>
<pre><code>foo@bar:~$ curl --header "Authorization: Bearer b872daf5827a75495c8194c6bfa4f90cf46c143e" http://localhost/farm.json
{"name":"farmos-server","url":"http:\/\/localhost","api_version":"1.1","user":{"uid":"1","name":"admin", ....
</code></pre>
<h4 id="password-credentials-grant">Password Credentials Grant</h4>
<p><strong>NOTE:</strong> Only use the <strong>Password Grant</strong> if the client can be trusted with a
farmOS username and password (this is considered <em>1st party</em>).</p>
<p>The Password Credentials Grant uses a farmOS <code>username</code> and <code>password</code> to
retrieve an <code>access_token</code> and <code>refresh_token</code> in one step. For the user, this
is the simplest type of <em>authorization.</em> Because the client can be trusted with
their farmOS Credentials, a users <code>username</code> and <code>password</code> can be collected
directly into a login form within the client application. These credentials are
then used (not stored) to request tokens which are used for <em>authentication</em>
with the farmOS server and retrieving data.</p>
<p>Requesting protected resources is a two step process:</p>
<p><strong>First</strong>, the client sends a POST request to the farmOS server <code>/oauth/token</code>
endpoint with <code>grant_type</code> set to <code>password</code> and a <code>username</code> and <code>password</code>
included in the request body.</p>
<pre><code>$ curl -X POST -d "grant_type=password&amp;username=username&amp;password=test&amp;client_id=farm&amp;scope=user_access" http://localhost/oauth/token
{"access_token":"e69c60dea3f5c59c95863928fa6fb860d3506fe9","expires_in":"300","token_type":"Bearer","scope":"user_access","refresh_token":"cead7d46d18d74daea83f114bc0b512ec4cc31c3"}
</code></pre>
<p><strong>second</strong>, the client sends the <code>access_token</code> in the request header to access protected
resources. The header is an Authorization header with a Bearer token:
 <code>Authorization: Bearer access_token</code></p>
<pre><code>foo@bar:~$ curl --header "Authorization: Bearer e69c60dea3f5c59c95863928fa6fb860d3506fe9" http://localhost/farm.json
{"name":"farmos-server","url":"http:\/\/localhost","api_version":"1.1","user":{"uid":"1","name":"admin", ....
</code></pre>
<h4 id="refreshing-tokens">Refreshing Tokens</h4>
<p>The <code>refresh_token</code> can be used to retrieve a new <code>access_token</code> if the token
has expired.</p>
<p>It is a one step process:</p>
<p>The client sends an authenticated request to the <code>/oauth/token</code>endpoint with
<code>grant_type</code> set to <code>refresh_token</code> and includes the <code>refresh_token</code>,
<code>client_id</code> and <code>client_secret</code> in the request body.</p>
<pre><code>foo@bar:~$ curl -X POST -H 'Authorization: Bearer ad52c04d26c1002084501d28b59196996f0bd93f' -d 'refresh_token=52e7a0e12e8ddd08b155b3b3ee385687fef01664&amp;grant_type=refresh_token&amp;client_id=farmos_api_client&amp;client_secret=client_secret' http://localhost/oauth/token
{"access_token":"acdbfabb736e42aa301b50fdda95d6b7fd3e7e14","expires_in":"300","token_type":"Bearer","scope":"user_access","refresh_token":"b73f4744840498a26f43447d8cf755238bfd391a"}
</code></pre>
<p>The server responds with an <code>access_token</code> and <code>refresh_token</code> that can be used
in future requests. The previous <code>access_token</code> and <code>refresh_token</code> will no
longer work.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../changes/" class="btn btn-neutral float-right" title="Changes">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../" class="btn btn-neutral" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../changes/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
